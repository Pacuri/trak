# TRAK Cursor Rules v2.0

You are building TRAK, a complete CRM and booking system for Serbian travel agencies.

**IMPORTANT: Read TRAK_CURSOR_BIBLE_v2.md for full implementation details.**

## Tech Stack
- Next.js 14+ (App Router)
- TypeScript (strict)
- Supabase (PostgreSQL + Realtime)
- Tailwind CSS
- shadcn/ui
- Lucide React icons
- React Hook Form + Zod
- Claude API (AI features)

## Language Rules
- Code, comments, variables: English
- UI text (buttons, labels): Serbian
- Database columns: English snake_case

## CRITICAL ANTI-PATTERNS

NEVER do these in agent dashboard:
1. NO avatars (colored circles with initials)
2. NO emojis in data (ğŸ–ï¸ Hotel, ğŸ‘¥ 10, ğŸ’° â‚¬100)
3. NO colorful icon soup (each icon different color)
4. NO links for expand/collapse (use buttons)

**Exception:** Emojis ARE allowed in client-facing urgency labels only.

## Two Inventory Types â­ NEW

Every offer has `inventory_type`:
- `owned` (Sopstveni kapacitet): Instant booking, show capacity bar
- `inquiry` (Na upit): Customer submits inquiry, agent must verify

Results page shows TWO SECTIONS:
1. "âš¡ REZERVIÅ ITE ODMAH" - owned offers with capacity
2. "ğŸ“‹ NA UPIT" - inquiry offers with response time

## Color System - Color is Earned

Default is neutral gray. Color only when meaningful.

| Meaning | Border | Background | Text |
|---------|--------|------------|------|
| OK | green-500 | green-50 | green-700 |
| Warning | amber-500 | amber-50 | amber-700 |
| Error | red-500 | red-50 | red-700 |
| Info | blue-500 | blue-50 | blue-700 |

### Border Rules
- Trip column top (4px): blue=default, amber=issues, green=traveling
- Card left (3px): green=OK, amber=issue, gray=neutral

### Badges
```tsx
<Badge className="bg-green-100 text-green-800">âœ“ PlaÄ‡eno</Badge>
<Badge className="bg-amber-100 text-amber-800">ÄŒeka uplatu</Badge>
```

## Key Component Patterns

### Two Card Types (Client-Facing)

**InstantOfferCard** (inventory_type='owned'):
- Shows capacity bar
- Button: "RezerviÅ¡i â†’"
- Links to /reserve/[offerId]

**InquiryOfferCard** (inventory_type='inquiry'):
- NO capacity bar
- Shows response time
- Button: "PoÅ¡alji upit â†’"
- Links to /inquiry/[offerId]

### Inquiry Dashboard (Agent-Facing)
```
[ğŸ”´ ÄŒeka odgovor (3)] [ğŸŸ¡ Proveravam (2)] [ğŸŸ¢ Odgovoreno (15)]

Each card shows:
- Customer name + phone
- Offer name + dates
- Time since inquiry (urgent if 10+ min)
- Actions: [Pozovi] [WhatsApp] [âœ… Dostupno] [âŒ Nije dost.]
```

## AI Features â­ NEW

1. **Message Parsing** - Viber/WhatsApp text â†’ Lead fields
2. **Screenshot OCR** - Image â†’ text â†’ Lead fields
3. **Lead Scoring** - 0-100 score + conversion probability
4. **Smart Matching** - Ranked offers based on qualification

Use Claude Haiku for all AI calls (~â‚¬9/month per agency).

## Abandoned Cart â­ NEW

Email popup after 10 seconds on results page:
- Captures email + gives 5% discount code
- 3 automated follow-up emails (+2h, +24h, +72h)
- Agency can enable/disable in settings

## Urgency Labels (Client-Facing Only)

Priority order - only ONE label per offer:
1. ğŸ”¥ POSLEDNJA MESTA (â‰¤2 spots)
2. â° ISTIÄŒE USKORO (â‰¤7 days)
3. ğŸ“ˆ POPUNJAVA SE (â‰¥70% booked)
4. ğŸ’° SNIÅ½ENO -X% (â‰¥10% discount)
5. ğŸ†• NOVO (â‰¤7 days old)
6. â­ POPULARNO (â‰¥10 views/24h)
7. ğŸ‘ PREPORUÄŒUJEMO (manual)

Target: ~50% with labels, ~50% without.

## Notifications

Real-time via Supabase Realtime:
```typescript
supabase.channel('notifications')
  .on('postgres_changes', { event: 'INSERT', table: 'notifications' }, handler)
  .subscribe()
```

For iOS users: default to SMS escalation (Browser push doesn't work reliably).

## Key Serbian Terms
| English | Serbian |
|---------|---------|
| Save | SaÄuvaj |
| Cancel | OtkaÅ¾i |
| Submit inquiry | PoÅ¡alji upit |
| Book now | RezerviÅ¡i odmah |
| Available | Dostupno |
| Not available | Nije dostupno |
| Awaiting response | ÄŒeka odgovor |
| Response time | Vreme odgovora |
| Per person | po osobi |
| Discount code | Kod za popust |

## File Structure (Matches Current Repo)
```
/src
  /app
    /(auth)/login, /register
    /(onboarding)/onboarding
    /(dashboard)/dashboard           â† Note: double "dashboard"
      /leads, /pipeline, /settings, /integrations, /analytics  â† EXISTS
      /offers, /reservations, /inquiries, /trips  â† NEW Phase 2+
    /(public)                        â† NEW
      /a/[slug]
        /qualify, /results, /reserve/[id], /inquiry/[id]
    /api                             â† NEW
      /leads, /offers, /reservations, /inquiries
      /ai (parse-message, parse-screenshot, score-lead, match-offers)
      /public (email-capture, inquiries)
  /components
    /pipeline                        â† EXISTS
    /offers, /qualification, /inquiry, /reservation, /trips  â† NEW
    /notifications                   â† NEW
  /hooks                             â† EXISTS
    use-leads, use-pipeline, use-user, use-organization
    use-offers, use-reservations, use-inquiries  â† NEW
  /lib
    /supabase                        â† EXISTS
    /ai, /email, /cron               â† NEW
  /types                             â† EXISTS (expand)
  /ai â­ NEW
  /email â­ NEW
  /cron â­ NEW
```

## Database New Tables â­ NEW

- `offer_inquiries` - Customer inquiries on on-request offers
- `abandoned_carts` - Email capture for cart recovery
- `user_notification_settings` - Per-user notification prefs

Key field additions:
- `offers.inventory_type` - 'owned' or 'inquiry'
- `agency_booking_settings.working_hours` - JSONB for response time
- `agency_booking_settings.abandoned_cart_*` - Cart recovery settings

## Database Capacity Rules
- Booking creates â†’ available_spots decreases (auto trigger)
- Booking cancels â†’ available_spots restores (auto trigger)
- â‰¤2 spots â†’ triggers "POSLEDNJA MESTA" label

## Before Submitting Checklist
- [ ] No avatars in agent views
- [ ] No emojis in agent data display
- [ ] Correct inventory_type handling
- [ ] Two sections on results page
- [ ] Inquiry flow complete
- [ ] Serbian UI text
- [ ] AI features use Claude Haiku
- [ ] Abandoned cart opt-in setting

**For complete code examples, component anatomy, database schema, and API patterns, see TRAK_CURSOR_BIBLE_v2.md**
